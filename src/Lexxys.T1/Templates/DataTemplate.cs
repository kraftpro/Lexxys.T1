// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version: 16.0.0.0
//  
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------
namespace Lexxys.T1.Templates
{
    using System.Data;
    using System.Linq;
    using System.Text;
    using System.Collections.Generic;
    using Lexxys;
    using System;
    
    /// <summary>
    /// Class to produce the template output
    /// </summary>
    
    #line 1 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "16.0.0.0")]
    public partial class DataTemplate : DataTemplateBase
    {
#line hidden
        /// <summary>
        /// Create the template output
        /// </summary>
        public virtual string TransformText()
        {
            this.Write("/*\r\n\tServer: ");
            
            #line 8 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Lexxys.Config.GetValue<Lexxys.ConnectionStringInfo>("database.connection").Server));
            
            #line default
            #line hidden
            this.Write("\r\n\tVersion ");
            
            #line 9 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(System.Reflection.Assembly.GetEntryAssembly().GetName().Version));
            
            #line default
            #line hidden
            this.Write(" at ");
            
            #line 9 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(DateTime.UtcNow.ToString("u")));
            
            #line default
            #line hidden
            this.Write("\r\n*/\r\nusing System;\r\nusing System.Collections.Generic;\r\nusing System.Data;\r\nusing" +
                    " System.Data.SqlClient;\r\nusing System.Diagnostics;\r\nusing System.IO;\r\nusing Syst" +
                    "em.Linq;\r\nusing System.Text;\r\nusing System.Threading.Tasks;\r\n\r\nusing Lexxys;\r\n");
            
            #line 22 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

if (Project == null)
	throw new ArgumentNullException(nameof(Project));

var dc = Project.Expression.DataContext;

foreach (var u in Project.Using)
{
	var v = u.TrimToNull();
	if (v == null)
		continue;
	if (!v.EndsWith(";"))
		v += ";";

            
            #line default
            #line hidden
            this.Write("using ");
            
            #line 36 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(v));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 37 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

}

            
            #line default
            #line hidden
            this.Write("\r\nnamespace ");
            
            #line 41 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Project.Namespace ?? "Entities"));
            
            #line default
            #line hidden
            this.Write(".Data\r\n{\r\n");
            
            #line 43 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

	foreach (TableInfo table in Tables.Values)
	{
		var cls = table.Class;
		string className = table.PublicName;
		string recordName = className + "Record";
		ColumnInfo keyColumn = table.KeyFields.Count == 1 ? table.KeyFields[0]: ColumnInfo.DefaultIdKey;
		TableInfo view = table.View;

            
            #line default
            #line hidden
            this.Write("\r\n\t[Serializable]\r\n\tpartial class ");
            
            #line 54 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(": IDump");
            
            #line 54 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Project.Implements == null ? "": ", " + Project.Implements));
            
            #line default
            #line hidden
            this.Write("\r\n\t{\r\n\t\t#region Fields\r\n");
            
            #line 57 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		foreach (var field in view.Fields.Union(cls.ExtraFields))
		{
			string comment = null;
			if (field.Bind != field.FieldName)
				comment = "\t// " + field.Bind;
			if (field.Reference != null)
				comment = (comment ?? "\t//") + " -> " + field.Reference;

            
            #line default
            #line hidden
            this.Write("\t\tpublic ");
            
            #line 66 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.CsFieldType));
            
            #line default
            #line hidden
            this.Write(" ");
            
            #line 66 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" { get; set; }");
            
            #line 66 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(comment ?? ""));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 67 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}

            
            #line default
            #line hidden
            this.Write("\r\n\t\tprivate ");
            
            #line 71 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" _originalCopy;\r\n\t\tprivate static readonly ");
            
            #line 72 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" _emptyRecord = new ");
            
            #line 72 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("();\r\n\t\t#endregion\r\n\r\n\t\tpublic ");
            
            #line 75 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("()\r\n\t\t{\r\n");
            
            #line 77 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		List<(ColumnInfo Field, string Expression)> initializators = table.Fields.Where(o => o.InitializationExpression != null).Select(o => (o, o.InitializationExpression)).ToList();
		for (int i = 0; i < initializators.Count; ++i)
		{

            
            #line default
            #line hidden
            this.Write("\t\t\t");
            
            #line 81 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(initializators[i].Field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = ");
            
            #line 81 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(initializators[i].Expression));
            
            #line default
            #line hidden
            this.Write(";\r\n");
            
            #line 82 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
		}

            
            #line default
            #line hidden
            this.Write("\t\t}\r\n\r\n\t\tpublic bool IsRecordNew => _originalCopy == null;\r\n\r\n");
            
            #line 87 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		List<ColumnInfo> freeFields = table.Fields.Where(o => !o.ControlledByDatasource).ToList();
		if (freeFields.All(o => o.IsDeterministic))
		{

            
            #line default
            #line hidden
            this.Write("\t\tpublic bool IsRecordModified\r\n\t\t{\r\n\t\t\tget\r\n\t\t\t{\r\n\t\t\t\t");
            
            #line 96 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" copy = _originalCopy ?? _emptyRecord;\r\n\t\t\t\treturn\r\n");
            
            #line 98 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			for (int i = 0; i < freeFields.Count; ++i)
			{
				var field = freeFields[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\tcopy.");
            
            #line 103 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" != ");
            
            #line 103 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            
            #line 103 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i < freeFields.Count - 1 ? " ||": ";"));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 104 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}

            
            #line default
            #line hidden
            this.Write("\t\t\t}\r\n\t\t}\r\n");
            
            #line 109 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}
		else
		{
			List<ColumnInfo> insertingFields = freeFields.Where(o => o.IsDeterministic).ToList();
			if (insertingFields.Count == 0)
			{
				if (freeFields.Count == 0)
				{

            
            #line default
            #line hidden
            this.Write("\t\tpublic bool IsRecordModified => _originalCopy == null;\r\n");
            
            #line 120 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}
				else
				{

            
            #line default
            #line hidden
            this.Write("\t\tpublic bool IsRecordModified => _originalCopy == null || ");
            
            #line 125 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(String.Join(" || ", freeFields.Select(o => String.Format("_originalCopy.{0} != {0}", o.FieldName)))));
            
            #line default
            #line hidden
            this.Write(";\r\n");
            
            #line 126 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}
			}
			else
			{

            
            #line default
            #line hidden
            this.Write("\t\tpublic bool IsRecordModified => _originalCopy == null ?\r\n");
            
            #line 133 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < insertingFields.Count; ++i)
				{
					var field = insertingFields[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t");
            
            #line 138 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" != ");
            
            #line 138 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.InitializationExpression ?? "default"));
            
            #line default
            #line hidden
            
            #line 138 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i < insertingFields.Count - 1 ? " ||": ":"));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 139 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            
            #line 142 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < freeFields.Count; ++i)
				{
					var field = freeFields[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t_originalCopy.");
            
            #line 147 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" != ");
            
            #line 147 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            
            #line 147 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i < freeFields.Count - 1 ? " ||": ";"));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 148 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}
			}
		}

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic bool IsFieldModified(Func<");
            
            #line 154 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(", object> accessor)\r\n\t\t{\r\n\t\t\treturn !object.Equals(accessor(this), accessor(_orig" +
                    "inalCopy ?? _emptyRecord));\r\n\t\t}\r\n\r\n\t\tpublic T GetOriginalValue<T>(Func<");
            
            #line 159 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(", T> accessor)\r\n\t\t{\r\n\t\t\treturn accessor(_originalCopy ?? _emptyRecord);\r\n\t\t}\r\n");
            
            #line 163 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		var asncTable = new (bool IsAsync, string AsAsync, string Async, string Await, Func<string, string> Type)[]
		{
			(false, "", "", "", o => o),
			(true, "async ", "Async", "await ", o => o == "void" ? "Task": "Task<" + o + ">")
		};

		foreach (var method in table.Loads)
		{
			var keys = method.Fields;
			if (keys.Count == 0)
				continue;
			var methodName = method.NameByParameters("Load");
			var queryClause = (cls.Query ?? view.GetSelectClause()) + (method.Joins == null ? "": " " + method.Joins) + method.MakeWhere(true) + method.MakeOrder();
			if (queryClause.IndexOf("order by", StringComparison.OrdinalIgnoreCase) > 0)
			{
				int i = queryClause.IndexOf("select ", StringComparison.OrdinalIgnoreCase);
				if (i >= 0)
					queryClause = queryClause.Insert(i + 7, "top 1 ");
			}

			string[] whereVars = method.MakeNotNulableWhereTable();
			string chooseExpression = method.GetNotNullableTableIndex();
			string tableName = "__" + Tool.ToCamelCase(methodName) + "Stmt";

			foreach (var a in asncTable)
			{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 192 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 192 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type(recordName)));
            
            #line default
            #line hidden
            this.Write(" ");
            
            #line 192 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(methodName));
            
            #line default
            #line hidden
            
            #line 192 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(");
            
            #line 192 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(method.MakeDeclaration()));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t{\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\t");
            
            #line 196 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" record = null;\r\n\t\t\t\t");
            
            #line 197 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 197 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Map");
            
            #line 197 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(1, o => (record = new ");
            
            #line 197 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("()).LoadRecord(o, 0),\r\n\t\t\t\t\t");
            
            #line 198 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(chooseExpression == null ? Strings.EscapeCsString(queryClause): $"{tableName}[{chooseExpression}]"));
            
            #line default
            #line hidden
            this.Write(",\r\n");
            
            #line 199 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < keys.Count; ++i)
				{
					var key = keys[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\tnew SqlParameter(\"@");
            
            #line 203 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetSqlParameterName()));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 203 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(keys[i].SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 203 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetLocalName()));
            
            #line default
            #line hidden
            
            #line 203 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.IsNullable ? " ?? (object)DBNull.Value": ""));
            
            #line default
            #line hidden
            this.Write(" }");
            
            #line 203 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i == keys.Count - 1 ? ");": ","));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 204 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\treturn record;\r\n\t\t\t}\r\n\t\t\tcatch (Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"table\", " +
                    "\"");
            
            #line 211 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n");
            
            #line 212 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < keys.Count; ++i)
				{
					var key = keys[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\t.Add(\"");
            
            #line 216 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetLocalName()));
            
            #line default
            #line hidden
            this.Write("\", ");
            
            #line 216 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetLocalName()));
            
            #line default
            #line hidden
            this.Write(")");
            
            #line 216 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i == keys.Count - 1 ? ";": ""));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 217 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 223 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
			if (whereVars.Length > 0)
			{

            
            #line default
            #line hidden
            this.Write("\t\tprivate static readonly string[] ");
            
            #line 228 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(tableName));
            
            #line default
            #line hidden
            this.Write(" = new[]\r\n\t\t\t{\r\n");
            
            #line 230 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < whereVars.Length; ++i)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 234 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Strings.EscapeCsString(queryClause + whereVars[i] + method.MakeOrder())));
            
            #line default
            #line hidden
            this.Write(",\r\n");
            
            #line 235 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t};\r\n");
            
            #line 239 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}

		foreach (var key in table.Fields.Where(o => o != keyColumn && o.IsUnique))
		{
			var name = key.FieldName;
			var idName = name.Substring(0, 1).ToLowerInvariant() + name.Substring(1);
			if (name.EndsWith("Id", StringComparison.Ordinal))
				name = name.Substring(0, name.Length - 2);
			foreach (var a in asncTable)
			{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 253 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 253 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type(recordName)));
            
            #line default
            #line hidden
            this.Write(" LoadBy");
            
            #line 253 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            
            #line 253 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(");
            
            #line 253 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.CsType));
            
            #line default
            #line hidden
            this.Write(" ");
            
            #line 253 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(idName));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t{\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\t");
            
            #line 257 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" record = null;\r\n\t\t\t\t");
            
            #line 258 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 258 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Map");
            
            #line 258 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(1, o => (record = new ");
            
            #line 258 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("()).LoadRecord(o, 0),\r\n\t\t\t\t\t\"");
            
            #line 259 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cls.Query ?? view.GetSelectClause()));
            
            #line default
            #line hidden
            this.Write(" where [");
            
            #line 259 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.Bind));
            
            #line default
            #line hidden
            this.Write("]=@");
            
            #line 259 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write("\",\r\n\t\t\t\t\tnew SqlParameter(\"@");
            
            #line 260 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 260 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 260 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(idName));
            
            #line default
            #line hidden
            this.Write(" });\r\n\t\t\t\treturn record;\r\n\t\t\t}\r\n\t\t\tcatch (Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"ta" +
                    "ble\", \"");
            
            #line 265 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n\t\t\t\t\t.Add(\"");
            
            #line 266 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write("\", ");
            
            #line 266 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(idName));
            
            #line default
            #line hidden
            this.Write(");\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 270 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}


		if (keyColumn.CsType == "int" && table.KeyFields.Count == 1)
		{
			foreach (var a in asncTable)
			{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 281 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 281 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type($"List<{recordName}>")));
            
            #line default
            #line hidden
            this.Write(" Collect");
            
            #line 281 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(IEnumerable<int> ids, bool ordered = false)\r\n\t\t{\r\n\t\t\tif (ids == null)\r\n\t\t\t\tretur" +
                    "n new List<");
            
            #line 284 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">();\r\n\t\t\tif (ordered && !(ids is ICollection<int> || ids is IReadOnlyCollection<i" +
                    "nt>))\r\n\t\t\t\tids = ids.ToList();\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\tvar result = new List<");
            
            #line 289 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">();\r\n\t\t\t\t");
            
            #line 290 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 290 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Map");
            
            #line 290 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(o =>\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar record = new ");
            
            #line 292 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("();\r\n\t\t\t\t\t\tif (record.LoadRecord(o, 0))\r\n\t\t\t\t\t\t\tresult.Add(record);\r\n\t\t\t\t\t}, \"");
            
            #line 295 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cls.Query ?? view.GetSelectClause()));
            
            #line default
            #line hidden
            this.Write(" where [");
            
            #line 295 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cls.Key ?? keyColumn.Bind));
            
            #line default
            #line hidden
            this.Write("] in \" + Dc.IdFilter(ids));\r\n\t\t\t\tif (!ordered || result.Count < 2)\r\n\t\t\t\t\treturn r" +
                    "esult;\r\n\t\t\t\tvar sorted = new List<");
            
            #line 298 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">(result.Count);\r\n\t\t\t\tforeach (var id in ids)\r\n\t\t\t\t{\r\n\t\t\t\t\tint k = result.FindInd" +
                    "ex(o => o.");
            
            #line 301 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(keyColumn.FieldName));
            
            #line default
            #line hidden
            this.Write(" == id);\r\n\t\t\t\t\tif (k >= 0)\r\n\t\t\t\t\t\tsorted.Add(result[k]);\r\n\t\t\t\t}\r\n\t\t\t\treturn sorte" +
                    "d;\r\n\t\t\t}\r\n\t\t\tcatch (Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"table\", \"");
            
            #line 309 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n\t\t\t\t\t.Add(\"ids\", Dc.IdFilter(ids));\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 314 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}

		var collected = new List<string>();

		foreach (var key in table.Fields.Where(o => o != keyColumn && o.IsUnique && o.CsType == "int"))
		{
			var nameItems = Strings.SplitByCapitals(key.GetPublicName());
			int nameItemsCount = nameItems.Length;
			if (nameItemsCount > 1 && String.Equals(nameItems[nameItemsCount-1], "id", StringComparison.OrdinalIgnoreCase))
				--nameItemsCount;
		    nameItems[nameItemsCount - 1] = Lingua.Plural(nameItems[nameItemsCount - 1]);
			var methodName = String.Concat(nameItems.Take(nameItemsCount));
			var idName = key.GetLocalName();
			foreach (var a in asncTable)
			{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 333 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 333 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type($"List<{recordName}>")));
            
            #line default
            #line hidden
            this.Write(" CollectBy");
            
            #line 333 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(methodName));
            
            #line default
            #line hidden
            
            #line 333 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(IEnumerable<int> ids, bool ordered = false)\r\n\t\t{\r\n\t\t\tif (ids == null)\r\n\t\t\t\tretur" +
                    "n new List<");
            
            #line 336 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">();\r\n\t\t\tif (ordered && !(ids is ICollection<int> || ids is IReadOnlyCollection<i" +
                    "nt>))\r\n\t\t\t\tids = ids.ToList();\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\tvar result = new List<");
            
            #line 341 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">();\r\n\t\t\t\t");
            
            #line 342 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 342 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Map");
            
            #line 342 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(o =>\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar record = new ");
            
            #line 344 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("();\r\n\t\t\t\t\t\tif (record.LoadRecord(o, 0))\r\n\t\t\t\t\t\t\tresult.Add(record);\r\n\t\t\t\t\t}, \"");
            
            #line 347 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cls.Query ?? view.GetSelectClause()));
            
            #line default
            #line hidden
            this.Write(" where [");
            
            #line 347 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.Bind));
            
            #line default
            #line hidden
            this.Write("] in \" + Dc.IdFilter(ids));\r\n\t\t\t\tif (!ordered || result.Count < 2)\r\n\t\t\t\t\treturn r" +
                    "esult;\r\n\t\t\t\tvar sorted = new List<");
            
            #line 350 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">(result.Count);\r\n\t\t\t\tforeach (var id in ids)\r\n\t\t\t\t{\r\n\t\t\t\t\tint k = result.FindInd" +
                    "ex(o => o.");
            
            #line 353 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.FieldName));
            
            #line default
            #line hidden
            this.Write(" == id);\r\n\t\t\t\t\tif (k >= 0)\r\n\t\t\t\t\t\tsorted.Add(result[k]);\r\n\t\t\t\t}\r\n\t\t\t\treturn sorte" +
                    "d;\r\n\t\t\t}\r\n\t\t\tcatch (Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"table\", \"");
            
            #line 361 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n\t\t\t\t\t.Add(\"ids\", Dc.IdFilter(ids));\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 366 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}

		foreach (var method in table.Collects)
		{
			var keys = method.Fields;
			if (keys.Count == 0)
				continue;
			var methodName = method.NameByParameters("Collect");
			if (collected.Contains(methodName))
				continue;
			collected.Add(methodName);

			var queryClause = (cls.Query ?? view.GetSelectClause("o")) + (method.Joins == null ? "": " " + method.Joins) + method.MakeWhere(true) + method.MakeOrder();

			string[] whereVars = method.MakeNotNulableWhereTable();
			string chooseExpression = method.GetNotNullableTableIndex();
			string tableName = "__" + Tool.ToCamelCase(methodName) + "Stmt";

			foreach (var a in asncTable)
			{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 390 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 390 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type($"List<{recordName}>")));
            
            #line default
            #line hidden
            this.Write(" ");
            
            #line 390 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(methodName));
            
            #line default
            #line hidden
            
            #line 390 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(");
            
            #line 390 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(method.MakeDeclaration()));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t{\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\tvar result = new List<");
            
            #line 394 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">();\r\n\t\t\t\t");
            
            #line 395 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 395 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Map");
            
            #line 395 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(o =>\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar record = new ");
            
            #line 397 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("();\r\n\t\t\t\t\t\tif (record.LoadRecord(o, 0))\r\n\t\t\t\t\t\t\tresult.Add(record);\r\n\t\t\t\t\t}, ");
            
            #line 400 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(chooseExpression == null ? Strings.EscapeCsString(queryClause): $"{tableName}[{chooseExpression}]"));
            
            #line default
            #line hidden
            this.Write(",\r\n");
            
            #line 401 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < keys.Count; ++i)
				{
					var key = keys[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\tnew SqlParameter(\"@");
            
            #line 405 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetSqlParameterName()));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 405 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 405 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetLocalName()));
            
            #line default
            #line hidden
            
            #line 405 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.IsNullable ? " ?? (object)DBNull.Value": ""));
            
            #line default
            #line hidden
            this.Write(" }");
            
            #line 405 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i == keys.Count - 1 ? ");": ","));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 406 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\treturn result;\r\n\t\t\t}\r\n\t\t\tcatch (Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"table\", " +
                    "\"");
            
            #line 412 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n");
            
            #line 413 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < keys.Count; ++i)
				{
					var key = keys[i];

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\t.Add(\"");
            
            #line 417 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetLocalName()));
            
            #line default
            #line hidden
            this.Write("\", ");
            
            #line 417 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.GetLocalName()));
            
            #line default
            #line hidden
            this.Write(")");
            
            #line 417 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i == keys.Count - 1 ? ";": ""));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 418 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 424 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
			if (whereVars.Length > 0)
			{

            
            #line default
            #line hidden
            this.Write("\t\tprivate static readonly string[] ");
            
            #line 429 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(tableName));
            
            #line default
            #line hidden
            this.Write(" = new[]\r\n\t\t\t{\r\n");
            
            #line 431 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < whereVars.Length; ++i)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 435 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Strings.EscapeCsString(queryClause + whereVars[i] + method.MakeOrder())));
            
            #line default
            #line hidden
            this.Write(",\r\n");
            
            #line 436 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t};\r\n");
            
            #line 440 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}

		foreach (var key in table.Fields.Where(o => o != keyColumn && !o.IsUnique && o.IsReference))
		{
			var name = key.GetPublicName();
			if (name.Length > 2 && name.EndsWith("Id", StringComparison.Ordinal))
				name = name.Substring(0, name.Length - 2);
			if (collected.Contains("CollectBy" + name))
				continue;
			collected.Add("CollectBy" + name);
			var local = key.GetLocalName();
			foreach (var a in asncTable)
			{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 457 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 457 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type($"List<{recordName}>")));
            
            #line default
            #line hidden
            this.Write(" CollectBy");
            
            #line 457 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            
            #line 457 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(");
            
            #line 457 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.CsType));
            
            #line default
            #line hidden
            this.Write(" ");
            
            #line 457 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(local));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t{\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\tvar result = new List<");
            
            #line 461 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(">();\r\n\t\t\t\t");
            
            #line 462 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 462 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Map");
            
            #line 462 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(o =>\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tvar record = new ");
            
            #line 464 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("();\r\n\t\t\t\t\t\tif (record.LoadRecord(o, 0))\r\n\t\t\t\t\t\t\tresult.Add(record);\r\n\t\t\t\t\t}, \"");
            
            #line 467 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cls.Query ?? view.GetSelectClause()));
            
            #line default
            #line hidden
            this.Write(" where [");
            
            #line 467 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.Bind));
            
            #line default
            #line hidden
            this.Write("]=@");
            
            #line 467 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write("\",\r\n\t\t\t\t\tnew SqlParameter(\"@");
            
            #line 468 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 468 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 468 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(local));
            
            #line default
            #line hidden
            this.Write(" });\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\t\t\tcatch (Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"ta" +
                    "ble\", \"");
            
            #line 473 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n\t\t\t\t\t.Add(\"");
            
            #line 474 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(local));
            
            #line default
            #line hidden
            this.Write("\", ");
            
            #line 474 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(local));
            
            #line default
            #line hidden
            this.Write(");\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 478 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}

            
            #line default
            #line hidden
            this.Write(@"
		public bool LoadRecord(System.Data.IDataRecord record, int position)
		{
			if (record == null)
				throw EX.ArgumentNull(""record"");
			if (position < 0)
				throw EX.ArgumentOutOfRange(""position"", position);
			if (position > record.FieldCount - ");
            
            #line 489 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(view.Fields.Count));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t\t\tthrow EX.ArgumentOutOfRange(\"position\", position, record.FieldCount - ");
            
            #line 490 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(view.Fields.Count));
            
            #line default
            #line hidden
            this.Write(");\r\n\t\t\ttry\r\n\t\t\t{\r\n");
            
            #line 493 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				foreach (var key in table.KeyFields)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\tif (record.IsDBNull(position");
            
            #line 497 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(key.Order > 1 ? " + " + (key.Order - 1).ToString(): ""));
            
            #line default
            #line hidden
            this.Write("))\r\n\t\t\t\t\treturn false;\r\n");
            
            #line 499 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
					
				}

            
            #line default
            #line hidden
            
            #line 502 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				string prefix = "";
				foreach (var field in view.Fields)
				{
					if (field.IsFixedLengthString)
					{
						if (field.IsNullable)
						{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 511 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = record.IsDBNull(");
            
            #line 511 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prefix));
            
            #line default
            #line hidden
            this.Write("position) ? null: ((string)record[position]).TrimEnd();\r\n");
            
            #line 512 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

						}
						else
						{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 517 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = ((string)record[");
            
            #line 517 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prefix));
            
            #line default
            #line hidden
            this.Write("position]).TrimEnd();\r\n");
            
            #line 518 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

						}
						continue;
					}

					string cast = "(" + field.CsType + ")";
					if (field.CsType != field.DbCsType)
						cast = cast + "(" + field.DbCsType + ")";

					if (field.IsNullable)
					{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 530 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = record.IsDBNull(");
            
            #line 530 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prefix));
            
            #line default
            #line hidden
            this.Write("position) ? (");
            
            #line 530 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.CsFieldType));
            
            #line default
            #line hidden
            this.Write(")null: ");
            
            #line 530 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cast));
            
            #line default
            #line hidden
            this.Write("record[position];\r\n");
            
            #line 531 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

					}
					else
					{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 536 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = ");
            
            #line 536 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cast));
            
            #line default
            #line hidden
            this.Write("record[");
            
            #line 536 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(prefix));
            
            #line default
            #line hidden
            this.Write("position];\r\n");
            
            #line 537 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

					}
					prefix = "++";
				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\t_originalCopy = CopyRecord(_originalCopy);\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tcatch " +
                    "(Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"position\", position);\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t" +
                    "\t}\r\n");
            
            #line 551 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		List<KeyValuePair<string, ColumnInfo>> fields = new List<KeyValuePair<string, ColumnInfo>>();
		var controlledFields = table.Fields.Where(o => o.ControlledByDatasource).ToList();

		foreach (var a in asncTable)
		{
			var virtualPrefix = a.IsAsync ?  "async Task<bool>": "bool";

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic ");
            
            #line 560 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(virtualPrefix));
            
            #line default
            #line hidden
            this.Write(" InsertRecord");
            
            #line 560 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write(@"()
		{
			if (!IsRecordNew)
				return false;

#if DEBUG
			Validate().Invariant(""InsertRecord"", () => this.Dump());
#endif
			try
			{
				Debug.Assert(_originalCopy == null);

				var insert = new SqlCommand();
				SqlParameterCollection pp = insert.Parameters;
");
            
            #line 574 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			StringBuilder ins1 = new StringBuilder()
				.Append("insert into ").Append(table.FullName).Append("(");
			StringBuilder ins2 = new StringBuilder()
				.Append("\nvalues(");

			foreach (var field in table.Fields.Where(o => !o.ControlledByDatasource))
			{
				string cast = field.CsType == field.DbCsType ? "": "(" + field.DbCsFieldType + ")";
				string nullable = field.IsNullable ? " ?? (object)DBNull.Value": "";
				string extras = field.Length == 0 || field.SqlDbType == SqlDbType.Money ? "":
					field.Precision == 0 ? ", Size = " + field.Size:
					field.Scale == 0 ? ", Precision = " + field.Precision:
						", Precision = " + field.Precision + ", Scale = " + field.Scale;

            
            #line default
            #line hidden
            this.Write("\t\t\t\tpp.Add(new SqlParameter(\"@");
            
            #line 589 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 589 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 589 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cast));
            
            #line default
            #line hidden
            
            #line 589 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            
            #line 589 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(nullable));
            
            #line default
            #line hidden
            
            #line 589 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(extras));
            
            #line default
            #line hidden
            this.Write(" });\r\n");
            
            #line 590 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

					ins1.Append("[").Append(field.Bind).Append("],");
					ins2.Append("@").Append(field.FieldName).Append(",");
			}
			--ins1.Length;
			--ins2.Length;

			ins1.Append(')').Append(ins2).Append(");");

			bool extraCondition = false;
			fields.Clear();

			if (controlledFields.Count > 0 && table.KeyFields.Count > 0)
			{
				if (table.KeyFields.Count == 1 && table.KeyFields[0].IsIdentity)
				{
					var id = table.KeyFields[0];
					fields.Add(new KeyValuePair<string, ColumnInfo>("p0", id));

            
            #line default
            #line hidden
            this.Write("\t\t\t\tSqlParameter p0 = new SqlParameter(\"@");
            
            #line 609 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(id.FieldName));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 609 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(id.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Direction = ParameterDirection.Output };\r\n\t\t\t\tpp.Add(p0);\r\n");
            
            #line 611 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

					if (controlledFields.Count == 1)
					{
						ins1.Append("\nset @").Append(id.FieldName).Append("=scope_identity();");
					}
					else
					{
						ins1.Append("\nselect @").Append(id.FieldName).Append("=[").Append(id.Bind).Append("]");
						int i = 1;
						foreach (var field in controlledFields)
						{
							if (field == id)
								continue;
							string name = string.Format("p{0}", i);
							fields.Add(new KeyValuePair<string, ColumnInfo>(name, field));

            
            #line default
            #line hidden
            this.Write("\t\t\t\tSqlParameter ");
            
            #line 627 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write(" = new SqlParameter(\"@");
            
            #line 627 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 627 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Direction = ParameterDirection.Output };\r\n\t\t\t\tpp.Add(");
            
            #line 628 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write(");\r\n");
            
            #line 629 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

							ins1.Append(",@").Append(field.FieldName).Append("=[").Append(field.Bind).Append("]");
							++i;
						}
						ins1.Append(" from ").Append(table.FullName).Append(" where [").Append(id.Bind).Append("]=scope_identity();");
					}
				}
				else
				{
					ins1.Append("\nselect ");
					int i = 0;
					foreach (var field in controlledFields)
					{
						++i;
						string name = string.Format("p{0}", i);
						fields.Add(new KeyValuePair<string, ColumnInfo>(name, field));
						string extras = field.Length == 0 || field.SqlDbType == SqlDbType.Money ? "":
							field.Precision == 0 ? ", Size = " + field.Size:
							field.Scale == 0 ? ", Precision = " + field.Precision:
								", Precision = " + field.Precision + ", Scale = " + field.Scale;

            
            #line default
            #line hidden
            this.Write("\t\t\t\tSqlParameter ");
            
            #line 650 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write(" = new SqlParameter(\"@");
            
            #line 650 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 650 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Direction = ParameterDirection.Output");
            
            #line 650 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(extras));
            
            #line default
            #line hidden
            this.Write(" };\r\n\t\t\t\tpp.Add(");
            
            #line 651 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write(");\r\n");
            
            #line 652 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

						ins1.Append("@").Append(field.FieldName).Append("=[").Append(field.Bind).Append("],");
					}
					--ins1.Length;
					ins1.Append(" from ").Append(table.FullName);
					extraCondition = true;
				}
			}

			string[] clause = ins1.ToString().Split('\n');


            
            #line default
            #line hidden
            this.Write("\t\t\t\tstring command = ");
            
            #line 664 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Strings.EscapeCsString(clause[0])));
            
            #line default
            #line hidden
            
            #line 664 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(clause.Length == 0 ? ";": " +"));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 665 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			for (int i = 1; i < clause.Length; ++i)
			{
					bool last = !extraCondition && i == clause.Length - 1;

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\t");
            
            #line 670 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(Strings.EscapeCsString("\r\n" + clause[i])));
            
            #line default
            #line hidden
            
            #line 670 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(last ? ";": " +"));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 671 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
			if (extraCondition)
			{
				string pad = "\\r\\nwhere";
				for (int k = 0; k < table.KeyFields.Count; ++k)
				{
					var field = table.KeyFields[k];
					bool last = k == table.KeyFields.Count - 1;

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\t\"");
            
            #line 681 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(pad));
            
            #line default
            #line hidden
            this.Write(" [");
            
            #line 681 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.Bind));
            
            #line default
            #line hidden
            this.Write("]\" + Dc.Equal(");
            
            #line 681 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(")");
            
            #line 681 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(last ? ";": " +"));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 682 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

					pad = "and";
				}
			}

            
            #line default
            #line hidden
            this.Write("\t\t\t\tinsert.CommandText = command;\r\n\t\t\t\t");
            
            #line 688 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 688 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Execute");
            
            #line 688 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(insert);\r\n\r\n");
            
            #line 690 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			foreach (var pair in fields)
			{
						string cast = "(" + pair.Value.CsType + ")";
						if (pair.Value.CsType != pair.Value.DbCsType)
							cast = cast + "(" + pair.Value.DbCsFieldType + ")";

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 697 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(pair.Value.FieldName));
            
            #line default
            #line hidden
            this.Write(" = ");
            
            #line 697 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cast));
            
            #line default
            #line hidden
            
            #line 697 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(pair.Key));
            
            #line default
            #line hidden
            this.Write(".Value;\r\n");
            
            #line 698 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}

            
            #line default
            #line hidden
            this.Write("\t\t\t\t_originalCopy = CopyRecord(_originalCopy);\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tcatch " +
                    "(Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"table\", \"");
            
            #line 706 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n\t\t\t\t\t.Add(\"Dump\", this.Dump());\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 711 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}

		if (table.KeyFields.Count > 0)
		{
			foreach (var a in asncTable)
			{
				var virtualPrefix = a.IsAsync ?  "async Task<bool>": "bool";

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic ");
            
            #line 721 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(virtualPrefix));
            
            #line default
            #line hidden
            this.Write(" UpdateRecord");
            
            #line 721 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write(@"()
		{
			if (!IsRecordModified)
				return false;

#if DEBUG
			Validate().Invariant(""UpdateRecord"", () => this.Dump());
#endif
			try
			{
				Debug.Assert(_originalCopy != null);

				var update = new SqlCommand();
				var text = new StringBuilder(""update ");
            
            #line 734 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write(" set \");\r\n\r\n\t\t\t\tvar pp = update.Parameters;\r\n");
            
            #line 737 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				foreach (var field in table.Fields.Where(o => !o.ControlledByDatasource))
				{
					string cast = field.CsType == field.DbCsType ? "": "(" + field.DbCsFieldType + ")";
					string nullable = field.IsNullable ? " ?? (object)DBNull.Value": "";
					string extras = field.Length == 0 || field.SqlDbType == SqlDbType.Money ? "":
						field.Precision == 0 ? ", Size = " + field.Size:
						field.Scale == 0 ? ", Precision = " + field.Precision:
							", Precision = " + field.Precision + ", Scale = " + field.Scale;

            
            #line default
            #line hidden
            this.Write("\t\t\t\tif (");
            
            #line 747 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" != _originalCopy.");
            
            #line 747 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t\t\t{\r\n\t\t\t\t\tpp.Add(new SqlParameter(\"@");
            
            #line 749 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 749 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 749 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cast));
            
            #line default
            #line hidden
            
            #line 749 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            
            #line 749 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(nullable));
            
            #line default
            #line hidden
            
            #line 749 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(extras));
            
            #line default
            #line hidden
            this.Write(" });\r\n\t\t\t\t\ttext.Append(\"[");
            
            #line 750 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.Bind));
            
            #line default
            #line hidden
            this.Write("]=@");
            
            #line 750 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(",\");\r\n\t\t\t\t}\r\n");
            
            #line 752 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				} // for by table.Fields

				fields.Clear();
				string condition;
				StringBuilder text = new StringBuilder();
				string pad = "";
				int i = 0;
				foreach (var field in table.KeyFields)
				{
					++i;
					string name = string.Format("p{0}", i);
					string cast = field.CsType == field.DbCsType ? "": "(" + field.DbCsFieldType + ")";
					string nullable = field.IsNullable ? " ?? (object)DBNull.Value": "";
					string extras = field.Length == 0 || field.SqlDbType == SqlDbType.Money ? "":
						field.Precision == 0 ? ", Size = " + field.Size:
						field.Scale == 0 ? ", Precision = " + field.Precision:
							", Precision = " + field.Precision + ", Scale = " + field.Scale;

            
            #line default
            #line hidden
            this.Write("\t\t\t\tvar ");
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write(" = new SqlParameter(\"@");
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.");
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.SqlDbType));
            
            #line default
            #line hidden
            this.Write(") { Value = ");
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(cast));
            
            #line default
            #line hidden
            this.Write("_originalCopy.");
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(nullable));
            
            #line default
            #line hidden
            
            #line 771 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(extras));
            
            #line default
            #line hidden
            this.Write(" };\r\n\t\t\t\tpp.Add(");
            
            #line 772 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(name));
            
            #line default
            #line hidden
            this.Write(");\r\n");
            
            #line 773 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

					fields.Add(new KeyValuePair<string, ColumnInfo>(string.Format("p{0}", i), field));
					string paramName = "@" + name;
					string bindName = "[" + field.Bind + "]";
					if (field.IsNullable)
						text.Append(pad).Append("(").Append(bindName).Append("is null and ").Append(paramName).Append(" is null")
							.Append(" or ").Append(bindName).Append("=").Append(paramName).Append(")");
					else
						text.Append(pad).Append(bindName).Append("=").Append(paramName);
					pad = " and ";
				}
				condition = text.ToString();

				var timestamp = controlledFields.FirstOrDefault(o => o.IsTimestamp);
				if (timestamp != null)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\tvar pX = new SqlParameter(\"@");
            
            #line 790 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(timestamp.FieldName));
            
            #line default
            #line hidden
            this.Write("\", SqlDbType.Timestamp) { Direction = ParameterDirection.Output };\r\n\t\t\t\tpp.Add(pX" +
                    ");\r\n\r\n\t\t\t\t--text.Length;\r\n\t\t\t\ttext.Append(\"\\r\\nwhere ");
            
            #line 794 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(condition));
            
            #line default
            #line hidden
            this.Write(";\")\r\n\t\t\t\t\t.Append(\"\\r\\nselect @");
            
            #line 795 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(timestamp.FieldName));
            
            #line default
            #line hidden
            this.Write("=[");
            
            #line 795 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(timestamp.Bind));
            
            #line default
            #line hidden
            this.Write("] from ");
            
            #line 795 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write(" where ");
            
            #line 795 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(condition));
            
            #line default
            #line hidden
            this.Write("\");\r\n");
            
            #line 796 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}
				else
				{

            
            #line default
            #line hidden
            this.Write("\r\n\t\t\t\t--text.Length;\r\n\t\t\t\ttext.Append(\"\\r\\nwhere ");
            
            #line 803 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(condition));
            
            #line default
            #line hidden
            this.Write(";\");\r\n");
            
            #line 804 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\tupdate.CommandText = text.ToString();\r\n\t\t\t\t");
            
            #line 808 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 808 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Execute");
            
            #line 808 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(update);\r\n");
            
            #line 809 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				if (timestamp != null)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t");
            
            #line 813 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(timestamp.FieldName));
            
            #line default
            #line hidden
            this.Write(" = (RowVersion)(byte[])pX.Value;\r\n");
            
            #line 814 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\t_originalCopy = CopyRecord(_originalCopy);\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tcatch " +
                    "(Exception flaw)\r\n\t\t\t{\r\n\t\t\t\tflaw.Add(\"table\", \"");
            
            #line 822 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write("\")\r\n\t\t\t\t\t.Add(\"Dump\", this.Dump());\r\n\t\t\t\tthrow;\r\n\t\t\t}\r\n\t\t}\r\n");
            
            #line 827 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			} // end for asyncTable

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic bool SaveChanges()\r\n\t\t{\r\n\t\t\treturn IsRecordNew ? InsertRecord(): Updat" +
                    "eRecord();\r\n\t\t}\r\n\r\n\t\tpublic Task<bool> SaveChangesAsync()\r\n\t\t{\r\n\t\t\treturn IsReco" +
                    "rdNew ? InsertRecordAsync(): UpdateRecordAsync();\r\n\t\t}\r\n");
            
            #line 840 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		} // if (table.KeyFields.Count > 0)

		if (table.Loads.Count > 0)
		{
			foreach (var a in asncTable)
			{
				foreach (var method in table.Loads)
				{
					if (method.Delete != true)
						continue;
					var keys = method.Fields;

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic static ");
            
            #line 854 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.AsAsync));
            
            #line default
            #line hidden
            
            #line 854 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Type("bool")));
            
            #line default
            #line hidden
            this.Write(" Delete");
            
            #line 854 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(");
            
            #line 854 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(string.Join(", ", keys.Select(o=> o.CsType + " " + Tool.NormalizeName(o.Name, NameStyle.LocalName)))));
            
            #line default
            #line hidden
            this.Write(")\r\n\t\t{\r\n\t\t\treturn ");
            
            #line 856 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Await));
            
            #line default
            #line hidden
            
            #line 856 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(dc));
            
            #line default
            #line hidden
            this.Write(".Execute");
            
            #line 856 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(a.Async));
            
            #line default
            #line hidden
            this.Write("(\"delete from ");
            
            #line 856 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(table.FullName));
            
            #line default
            #line hidden
            this.Write(" where ");
            
            #line 856 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(string.Join(" and ", keys.Select(o=> "[" + o.Bind + "]=@" + Tool.NormalizeName(o.Name, NameStyle.PublicName)))));
            
            #line default
            #line hidden
            this.Write("\", ");
            
            #line 856 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(string.Join(", ", keys.Select(o=> "new SqlParameter(\"@" + Tool.NormalizeName(o.Name, NameStyle.PublicName) + "\", SqlDbType." + o.SqlDbType + ") { Value = " + Tool.NormalizeName(o.Name, NameStyle.LocalName) + " }"))));
            
            #line default
            #line hidden
            this.Write(") > 0;\r\n\t\t}\r\n");
            
            #line 858 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}
			}
		}

            
            #line default
            #line hidden
            
            #line 863 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		List<(ColumnInfo Field, string Expression)> validators = table.Fields
			.Where(f => !f.IsIdentity)
			.SelectMany(o => o.ValidationExpression.Where(o => !String.IsNullOrEmpty(o))
			.Select(x => (o, x)))
			.ToList();
		if (validators.Count == 0)
		{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic ValidationResults Validate()\r\n\t\t{\r\n\t\t\treturn ValidationResults.Empty;\r" +
                    "\n\t\t}\r\n");
            
            #line 877 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}
		else if (validators.Count == 1)
		{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic ValidationResults Validate()\r\n\t\t{\r\n\t\t\treturn IsRecordNew || ");
            
            #line 885 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[0].Field.FieldName));
            
            #line default
            #line hidden
            this.Write(" != _originalCopy.");
            
            #line 885 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[0].Field.FieldName));
            
            #line default
            #line hidden
            this.Write(" ? ");
            
            #line 885 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[0].Expression));
            
            #line default
            #line hidden
            this.Write(": ValidationResults.Empty;\r\n\t\t}\r\n");
            
            #line 887 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}
		else
		{

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic ValidationResults Validate()\r\n\t\t{\r\n");
            
            #line 895 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			if (validators.Count == 0)
			{

            
            #line default
            #line hidden
            this.Write("\t\t\treturn _originalCopy == null ? ValidationResults.Empty:\r\n");
            
            #line 899 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
			else
			{

            
            #line default
            #line hidden
            this.Write("\t\t\treturn _originalCopy == null ?\r\n\t\t\t\tValidationResults.Create(\r\n");
            
            #line 905 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < validators.Count; ++i)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\t");
            
            #line 908 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[i].Expression));
            
            #line default
            #line hidden
            
            #line 908 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i == validators.Count - 1 ? "):": ","));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 909 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t\t\tValidationResults.Create(\r\n");
            
            #line 912 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				for (int i = 0; i < validators.Count; ++i)
				{

            
            #line default
            #line hidden
            this.Write("\t\t\t\t\t");
            
            #line 915 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[i].Field.FieldName));
            
            #line default
            #line hidden
            this.Write(" == _originalCopy.");
            
            #line 915 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[i].Field.FieldName));
            
            #line default
            #line hidden
            this.Write(" ? null: ");
            
            #line 915 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(validators[i].Expression));
            
            #line default
            #line hidden
            
            #line 915 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(i == validators.Count - 1 ? ");": ","));
            
            #line default
            #line hidden
            this.Write("\r\n");
            
            #line 916 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

				}

            
            #line default
            #line hidden
            this.Write("\t\t}\r\n");
            
            #line 920 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}
		}

            
            #line default
            #line hidden
            this.Write("\r\n\t\tpublic DumpWriter DumpContent(DumpWriter writer)\r\n\t\t{\r\n\t\t\tif (writer == null)" +
                    "\r\n\t\t\t\treturn null;\r\n\t\t\ttry\r\n\t\t\t{\r\n\t\t\t\t");
            
            #line 931 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" copy = _originalCopy ?? this;\r\n");
            
            #line 932 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		string comma = "";
		foreach (var field in view.Fields)
		{

            
            #line default
            #line hidden
            this.Write("\t\t\t\twriter.Text(\"");
            
            #line 936 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(comma + field.FieldName));
            
            #line default
            #line hidden
            this.Write("=\").Dump(");
            
            #line 936 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write("); if (");
            
            #line 936 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" != copy.");
            
            #line 936 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(") writer.Text(\"(+)\");\r\n");
            
            #line 937 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			comma = ",";
		}

            
            #line default
            #line hidden
            this.Write("\t\t\t}\r\n\t\t\tcatch\r\n\t\t\t{\r\n\t\t\t}\r\n\t\t\treturn writer;\r\n\t\t}\r\n\r\n\t\tpublic ");
            
            #line 948 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" MakeACopy(");
            
            #line 948 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" that = null)\r\n\t\t{\r\n\t\t\tif (that == null || that == _emptyRecord)\r\n\t\t\t\tthat = new " +
                    "");
            
            #line 951 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write("();\r\n\r\n");
            
            #line 953 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		foreach (var field in view.Fields.Where(o => !o.ControlledByDatasource && o.IsDeterministic))
		{

            
            #line default
            #line hidden
            this.Write("\t\t\tthat.");
            
            #line 956 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = ");
            
            #line 956 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(";\r\n");
            
            #line 957 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}

            
            #line default
            #line hidden
            this.Write("\t\t\treturn that;\r\n\t\t}\r\n\r\n\t\tprivate ");
            
            #line 962 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" CopyRecord(");
            
            #line 962 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(recordName));
            
            #line default
            #line hidden
            this.Write(" that)\r\n\t\t{\r\n");
            
            #line 964 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		var computedFields = view.Fields.Where(o => o.ControlledByDatasource || !o.IsDeterministic).ToList();
		if (computedFields.Count == 0)
		{

            
            #line default
            #line hidden
            this.Write("\t\t\treturn MakeACopy(that);\r\n");
            
            #line 969 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}
		else
		{

            
            #line default
            #line hidden
            this.Write("\t\t\tthat = MakeACopy(that);\r\n");
            
            #line 974 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			foreach (var field in computedFields)
			{

            
            #line default
            #line hidden
            this.Write("\t\t\tthat.");
            
            #line 977 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(" = this.");
            
            #line 977 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"
            this.Write(this.ToStringHelper.ToStringWithCulture(field.FieldName));
            
            #line default
            #line hidden
            this.Write(";\r\n");
            
            #line 978 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

			}

            
            #line default
            #line hidden
            this.Write("\t\t\treturn that;\r\n");
            
            #line 981 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

		}

            
            #line default
            #line hidden
            this.Write("\t\t}\r\n\t}\r\n");
            
            #line 986 "C:\Projects\kraftpro\Lexxys.T1\src\Lexxys.T1\Templates\DataTemplate.tt"

	}

            
            #line default
            #line hidden
            this.Write("}");
            return this.GenerationEnvironment.ToString();
        }
    }
    
    #line default
    #line hidden
    #region Base class
    /// <summary>
    /// Base class for this transformation
    /// </summary>
    [global::System.CodeDom.Compiler.GeneratedCodeAttribute("Microsoft.VisualStudio.TextTemplating", "16.0.0.0")]
    public class DataTemplateBase
    {
        #region Fields
        private global::System.Text.StringBuilder generationEnvironmentField;
        private global::System.CodeDom.Compiler.CompilerErrorCollection errorsField;
        private global::System.Collections.Generic.List<int> indentLengthsField;
        private string currentIndentField = "";
        private bool endsWithNewline;
        private global::System.Collections.Generic.IDictionary<string, object> sessionField;
        #endregion
        #region Properties
        /// <summary>
        /// The string builder that generation-time code is using to assemble generated output
        /// </summary>
        protected System.Text.StringBuilder GenerationEnvironment
        {
            get
            {
                if ((this.generationEnvironmentField == null))
                {
                    this.generationEnvironmentField = new global::System.Text.StringBuilder();
                }
                return this.generationEnvironmentField;
            }
            set
            {
                this.generationEnvironmentField = value;
            }
        }
        /// <summary>
        /// The error collection for the generation process
        /// </summary>
        public System.CodeDom.Compiler.CompilerErrorCollection Errors
        {
            get
            {
                if ((this.errorsField == null))
                {
                    this.errorsField = new global::System.CodeDom.Compiler.CompilerErrorCollection();
                }
                return this.errorsField;
            }
        }
        /// <summary>
        /// A list of the lengths of each indent that was added with PushIndent
        /// </summary>
        private System.Collections.Generic.List<int> indentLengths
        {
            get
            {
                if ((this.indentLengthsField == null))
                {
                    this.indentLengthsField = new global::System.Collections.Generic.List<int>();
                }
                return this.indentLengthsField;
            }
        }
        /// <summary>
        /// Gets the current indent we use when adding lines to the output
        /// </summary>
        public string CurrentIndent
        {
            get
            {
                return this.currentIndentField;
            }
        }
        /// <summary>
        /// Current transformation session
        /// </summary>
        public virtual global::System.Collections.Generic.IDictionary<string, object> Session
        {
            get
            {
                return this.sessionField;
            }
            set
            {
                this.sessionField = value;
            }
        }
        #endregion
        #region Transform-time helpers
        /// <summary>
        /// Write text directly into the generated output
        /// </summary>
        public void Write(string textToAppend)
        {
            if (string.IsNullOrEmpty(textToAppend))
            {
                return;
            }
            // If we're starting off, or if the previous text ended with a newline,
            // we have to append the current indent first.
            if (((this.GenerationEnvironment.Length == 0) 
                        || this.endsWithNewline))
            {
                this.GenerationEnvironment.Append(this.currentIndentField);
                this.endsWithNewline = false;
            }
            // Check if the current text ends with a newline
            if (textToAppend.EndsWith(global::System.Environment.NewLine, global::System.StringComparison.CurrentCulture))
            {
                this.endsWithNewline = true;
            }
            // This is an optimization. If the current indent is "", then we don't have to do any
            // of the more complex stuff further down.
            if ((this.currentIndentField.Length == 0))
            {
                this.GenerationEnvironment.Append(textToAppend);
                return;
            }
            // Everywhere there is a newline in the text, add an indent after it
            textToAppend = textToAppend.Replace(global::System.Environment.NewLine, (global::System.Environment.NewLine + this.currentIndentField));
            // If the text ends with a newline, then we should strip off the indent added at the very end
            // because the appropriate indent will be added when the next time Write() is called
            if (this.endsWithNewline)
            {
                this.GenerationEnvironment.Append(textToAppend, 0, (textToAppend.Length - this.currentIndentField.Length));
            }
            else
            {
                this.GenerationEnvironment.Append(textToAppend);
            }
        }
        /// <summary>
        /// Write text directly into the generated output
        /// </summary>
        public void WriteLine(string textToAppend)
        {
            this.Write(textToAppend);
            this.GenerationEnvironment.AppendLine();
            this.endsWithNewline = true;
        }
        /// <summary>
        /// Write formatted text directly into the generated output
        /// </summary>
        public void Write(string format, params object[] args)
        {
            this.Write(string.Format(global::System.Globalization.CultureInfo.CurrentCulture, format, args));
        }
        /// <summary>
        /// Write formatted text directly into the generated output
        /// </summary>
        public void WriteLine(string format, params object[] args)
        {
            this.WriteLine(string.Format(global::System.Globalization.CultureInfo.CurrentCulture, format, args));
        }
        /// <summary>
        /// Raise an error
        /// </summary>
        public void Error(string message)
        {
            System.CodeDom.Compiler.CompilerError error = new global::System.CodeDom.Compiler.CompilerError();
            error.ErrorText = message;
            this.Errors.Add(error);
        }
        /// <summary>
        /// Raise a warning
        /// </summary>
        public void Warning(string message)
        {
            System.CodeDom.Compiler.CompilerError error = new global::System.CodeDom.Compiler.CompilerError();
            error.ErrorText = message;
            error.IsWarning = true;
            this.Errors.Add(error);
        }
        /// <summary>
        /// Increase the indent
        /// </summary>
        public void PushIndent(string indent)
        {
            if ((indent == null))
            {
                throw new global::System.ArgumentNullException("indent");
            }
            this.currentIndentField = (this.currentIndentField + indent);
            this.indentLengths.Add(indent.Length);
        }
        /// <summary>
        /// Remove the last indent that was added with PushIndent
        /// </summary>
        public string PopIndent()
        {
            string returnValue = "";
            if ((this.indentLengths.Count > 0))
            {
                int indentLength = this.indentLengths[(this.indentLengths.Count - 1)];
                this.indentLengths.RemoveAt((this.indentLengths.Count - 1));
                if ((indentLength > 0))
                {
                    returnValue = this.currentIndentField.Substring((this.currentIndentField.Length - indentLength));
                    this.currentIndentField = this.currentIndentField.Remove((this.currentIndentField.Length - indentLength));
                }
            }
            return returnValue;
        }
        /// <summary>
        /// Remove any indentation
        /// </summary>
        public void ClearIndent()
        {
            this.indentLengths.Clear();
            this.currentIndentField = "";
        }
        #endregion
        #region ToString Helpers
        /// <summary>
        /// Utility class to produce culture-oriented representation of an object as a string.
        /// </summary>
        public class ToStringInstanceHelper
        {
            private System.IFormatProvider formatProviderField  = global::System.Globalization.CultureInfo.InvariantCulture;
            /// <summary>
            /// Gets or sets format provider to be used by ToStringWithCulture method.
            /// </summary>
            public System.IFormatProvider FormatProvider
            {
                get
                {
                    return this.formatProviderField ;
                }
                set
                {
                    if ((value != null))
                    {
                        this.formatProviderField  = value;
                    }
                }
            }
            /// <summary>
            /// This is called from the compile/run appdomain to convert objects within an expression block to a string
            /// </summary>
            public string ToStringWithCulture(object objectToConvert)
            {
                if ((objectToConvert == null))
                {
                    throw new global::System.ArgumentNullException("objectToConvert");
                }
                System.Type t = objectToConvert.GetType();
                System.Reflection.MethodInfo method = t.GetMethod("ToString", new System.Type[] {
                            typeof(System.IFormatProvider)});
                if ((method == null))
                {
                    return objectToConvert.ToString();
                }
                else
                {
                    return ((string)(method.Invoke(objectToConvert, new object[] {
                                this.formatProviderField })));
                }
            }
        }
        private ToStringInstanceHelper toStringHelperField = new ToStringInstanceHelper();
        /// <summary>
        /// Helper to produce culture-oriented representation of an object as a string
        /// </summary>
        public ToStringInstanceHelper ToStringHelper
        {
            get
            {
                return this.toStringHelperField;
            }
        }
        #endregion
    }
    #endregion
}
